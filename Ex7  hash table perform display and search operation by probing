from collections import defaultdict

class Bucket:
    def __init__(self, capacity, local_depth):
        self.capacity = capacity
        self.local_depth = local_depth
        self.keys = []

    def insert(self, key):
        if key not in self.keys:
            self.keys.append(key)

    def remove(self, key):
        if key in self.keys:
            self.keys.remove(key)

    def is_full(self):
        return len(self.keys) >= self.capacity

    def __str__(self):
        return f"Keys: {self.keys}, depth={self.local_depth}"


class ExtendibleHashTable:
    def __init__(self, bucket_capacity=2):
        self.global_depth = 1
        self.bucket_capacity = bucket_capacity
        # Create 2^global_depth buckets initially
        self.directory = [Bucket(bucket_capacity, 1) for _ in range(2 ** self.global_depth)]

    def _hash(self, key):
        return hash(key) & ((1 << self.global_depth) - 1)

    def search(self, key):
        index = self._hash(key)
        bucket = self.directory[index]
        return key in bucket.keys

    def insert(self, key):
        index = self._hash(key)
        bucket = self.directory[index]
        bucket.insert(key)

        # If bucket is full, split it
        if bucket.is_full():
            self._split_bucket(index)

    def delete(self, key):
        index = self._hash(key)
        bucket = self.directory[index]
        bucket.remove(key)

    def _split_bucket(self, index):
        bucket = self.directory[index]

        # If local depth equals global depth, double the directory
        if bucket.local_depth == self.global_depth:
            self._double_directory()

        # Create a new bucket with incremented local depth
        new_bucket = Bucket(self.bucket_capacity, bucket.local_depth + 1)
        bucket.local_depth += 1

        # Redistribute keys
        all_keys = bucket.keys.copy()
        bucket.keys.clear()

        # Update directory references
        for i in range(len(self.directory)):
            if self.directory[i] is bucket:
                if (i >> (bucket.local_depth - 1)) & 1:
                    self.directory[i] = new_bucket

        # Reinsert keys
        for key in all_keys:
            self.insert(key)

    def _double_directory(self):
        self.global_depth += 1
        self.directory.extend(self.directory.copy())

    def display(self):
        print(f"Global Depth: {self.global_depth}")
        for i, bucket in enumerate(self.directory):
            print(f"Dir[{i:0{self.global_depth}b}] -> {bucket}")
        print("-" * 40)


# Example Usage
if __name__ == "__main__":
    eht = ExtendibleHashTable(bucket_capacity=2)
    eht.insert(5)
    eht.insert(7)
    eht.insert(9)
    eht.insert(15)
    eht.insert(23)

    eht.display()

    print("Search 9:", eht.search(9))
    eht.delete(9)
    print("Search 9 after delete:", eht.search(9))
    eht.display()
